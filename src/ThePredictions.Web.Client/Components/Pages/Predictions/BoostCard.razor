@using ThePredictions.Contracts.Boosts

<div class="boost-card" role="button" tabindex="0"
     aria-pressed="@IsSelected"
     aria-disabled="@IsDisabled"
     title="@Tooltip"
     @onclick="HandleToggle"
     @onkeydown="HandleKeyDown">

    <div class="boost-hex">
        <img src="@CurrentImageUrl" alt="@ImageAlt" class="boost-img" />
    </div>

    @if (Eligibility is not null)
    {
        if (BoostCode == "None")
        {
            <div class="badge-group badge-group--green">
                <span class="badge-icon">
                    <span class="fw-bold">âˆž</span>
                </span>

                <span>remaining</span>
            </div>
        }
        else
        {
            <div class="@GetBoostRemainingCss(DisplayRemaining)">
                <span class="badge-icon">
                    <span class="fw-bold">@DisplayRemaining</span>
                </span>

                <span>remaining</span>
            </div>
        }
    }
</div>

@code {
    [Parameter, EditorRequired] public int LeagueId { get; set; }
    [Parameter, EditorRequired] public int RoundId { get; set; }

    [Parameter] public string BoostCode { get; set; } = string.Empty;
    [Parameter] public string ImageUrl { get; set; } = string.Empty;
    [Parameter] public string SelectedImageUrl { get; set; } = string.Empty;
    [Parameter] public string DisabledImageUrl { get; set; } = string.Empty;
    [Parameter] public string ImageAlt { get; set; } = string.Empty;
    [Parameter] public string Tooltip { get; set; } = string.Empty;
    [Parameter] public bool IsSelected { get; set; }

    [Parameter] public BoostEligibilityDto? Eligibility { get; set; }
    [Parameter] public EventCallback<bool> IsSelectedChanged { get; set; }

    private bool _initialized;
    private bool _initiallySelected;          
    private int _serverRemaining;             
    private bool _localSelected;         

    private bool IsDisabled => !_initiallySelected && (Eligibility == null || !Eligibility.CanUse || Eligibility.AlreadyUsedThisRound);

    private string CurrentImageUrl =>
        IsSelected ? SelectedImageUrl :
        IsDisabled ? DisabledImageUrl :
        ImageUrl;


    private int DisplayRemaining
    {
        get
        {
            if (Eligibility == null)
                return 0;

            var baseVal = _serverRemaining;
            var delta = _initiallySelected switch
            {
                true when !_localSelected => 1,
                false when _localSelected => -1,
                _ => 0
            };

            var value = baseVal + delta;
            return Math.Max(0, value);
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!_initialized)
        {
            _initiallySelected = IsSelected;
            _localSelected = IsSelected;
            _serverRemaining = Eligibility?.RemainingWindowUses ?? 0;
            _initialized = true;
        }
        else
        {
            _localSelected = IsSelected;

            if (Eligibility is not null)
                _serverRemaining = Eligibility.RemainingWindowUses;
        }

        await base.OnParametersSetAsync();
    }

    private async Task HandleToggle()
    {
        if (IsDisabled)
            return;

        IsSelected = !IsSelected;
        await IsSelectedChanged.InvokeAsync(IsSelected);
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" || e.Key == " ")
            await HandleToggle();
    }

    private static string GetBoostRemainingCss(int remaining)
    {
        return remaining <= 0 ? "badge-group badge-group--red" : "badge-group badge-group--green";
    }
}
