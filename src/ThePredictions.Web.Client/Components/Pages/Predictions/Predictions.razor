@page "/predictions/{RoundId:int}"

@attribute [Authorize]

@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject BoostClientService BoostClient

@using ThePredictions.Contracts.Boosts
@using ThePredictions.Contracts.Dashboard
@using ThePredictions.Contracts.Predictions
@using ThePredictions.Web.Client.Components.Pages.Dashboard
@using ThePredictions.Web.Client.Services.Boosts

<PageTitle>Predictions - Round @(_pageData?.RoundNumber)</PageTitle>

<div class="page-container">
    <div class="form-container extra-wide">
        @if (_isLoading)
        {
            <p class="text-center text-white"><em>Loading...</em></p>
        }
        else if (_pageData != null)
        {
            <div class="text-center mb-4">
                <h3 class="fw-bold text-white mb-1">@_pageData.SeasonName</h3>
                <p class="fw-bold text-white-50 mb-2">Round @_pageData.RoundNumber</p>

                @if ((_pageData.DeadlineUtc - DateTime.UtcNow).TotalHours < 24)
                {
                    <CountdownTimer DeadlineUtc="_pageData.DeadlineUtc" />
                }
                else
                {
                    <div class="badge-group badge-group--red">
                        <span class="badge-icon"><i class="bi bi-alarm"></i></span>
                        <LocalTime UtcDate="@_pageData.DeadlineUtc" />
                    </div>
                }
            </div>

            <EditForm Model="_model" OnValidSubmit="HandleSubmitPredictionsAsync">
                <FluentValidationValidator />
                <ApiError Message="@_errorMessage" />
                <ApiSuccess Message="@_successMessage" />

                <div class="prediction-grid">
                    @foreach (var match in _pageData.Matches.OrderBy(m => m.MatchDateTimeUtc).ThenBy(m => m.HomeTeamShortName))
                    {
                        <div class="prediction-card">
                            <div class="prediction-card-header">
                                <LocalTime UtcDate="@match.MatchDateTimeUtc" Format="dddd dd MMM yyyy 'at' HH:mm" />
                            </div>
                            <div class="prediction-card-body">
                                <div class="team-display">
                                    <img src="@match.HomeTeamLogoUrl" class="match-logo" alt="Home Team Logo" />
                                    <span class="team-name d-none d-sm-block">@match.HomeTeamName</span>
                                    <span class="team-name d-sm-none">@match.HomeTeamAbbreviation</span>
                                </div>
                                <div class="score-input-group">
                                    <div class="score-input-stepper">
                                        <button type="button" class="stepper-btn" @onclick="() => UpdateScore(match, true, 1)" disabled="@_pageData.IsPastDeadline">
                                            <span class="bi bi-caret-up-fill"></span>
                                        </button>
                                        <div class="score-value">@match.PredictedHomeScore</div>
                                        <button type="button" class="stepper-btn" @onclick="() => UpdateScore(match, true, -1)" disabled="@_pageData.IsPastDeadline">
                                            <span class="bi bi-caret-down-fill"></span>
                                        </button>
                                    </div>
                                    <span class="vs-separator">-</span>
                                    <div class="score-input-stepper">
                                        <button type="button" class="stepper-btn" @onclick="() => UpdateScore(match, false, 1)" disabled="@_pageData.IsPastDeadline">
                                            <span class="bi bi-caret-up-fill"></span>
                                        </button>
                                        <div class="score-value">@match.PredictedAwayScore</div>
                                        <button type="button" class="stepper-btn" @onclick="() => UpdateScore(match, false, -1)" disabled="@_pageData.IsPastDeadline">
                                            <span class="bi bi-caret-down-fill"></span>
                                        </button>
                                    </div>
                                </div>
                                <div class="team-display">
                                    <img src="@match.AwayTeamLogoUrl" class="match-logo" alt="Away Team Logo" />
                                    <span class="team-name d-none d-sm-block">@match.AwayTeamName</span>
                                    <span class="team-name d-sm-none">@match.AwayTeamAbbreviation</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                @if (!_pageData.IsPastDeadline && _hasVisibleBoosts)
                {
                    <div class="mb-3 mt-4">
                        <h3 class="text-white text-center mb-4">Boosts</h3>

                        @if (_loadingBoostEligibility)
                        {
                            <div class="text-white-50">Loading boosts...</div>
                        }
                        else
                        {
                            <div class="d-flex flex-wrap gap-4">
                                @{
                                    var leaguesWithBoosts = _pageData.Leagues.Where(l => l.HasBoosts).ToList();
                                }

                                @foreach (var league in leaguesWithBoosts)
                                {
                                    var leagueId = league.LeagueId;

                                    if (!_boostOptions.TryGetValue(leagueId, out var allOptions))
                                    {
                                        continue;
                                    }

                                    var selectedCode = GetSelectedCode(leagueId);
                                    var actionableOptions = GetActionableOptions(allOptions, selectedCode);
                                    var futureBoostMessages = GetFutureBoostMessages(allOptions, selectedCode);

                                    if (actionableOptions.Count == 0 && futureBoostMessages.Count == 0)
                                    {
                                        continue;
                                    }

                                    <div class="boost-league-row w-100">
                                        <h5 class="text-center text-white mb-2">@league.Name</h5>

                                        @if (actionableOptions.Count > 0)
                                        {
                                            <BoostSelector LeagueId="@leagueId"
                                                           RoundId="@_pageData.RoundId"
                                                           Options="@actionableOptions"
                                                           SelectedCode="@selectedCode"
                                                           SelectedCodeChanged="@(async c => await SetSelectedCode(leagueId, c))" />
                                        }

                                        @foreach (var message in futureBoostMessages)
                                        {
                                            <div class="text-white-50 text-center mt-2">
                                                <i class="bi bi-clock me-1"></i>@message
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }

                @if (!_pageData.IsPastDeadline)
                {
                    <div class="d-flex justify-content-center mt-4">
                        <button type="submit" class="btn btn-lg green-button" disabled="@_isBusy">
                            @if (_isBusy)
                            {
                                <span class="spinner-border spinner-border-sm"></span>
                                <span> Saving...</span>
                            }

                            else
                            {
                                <span class="bi bi-check-circle-fill me-2"></span>
                                <span>Save Predictions</span>
                            }
                        </button>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning mt-4">The deadline for this round has passed. Predictions are locked.</div>
                }
            </EditForm>
        }
    </div>
</div>

@code {
    [Parameter]
    public int RoundId { get; set; }

    private PredictionPageDto? _pageData;
    private readonly SubmitPredictionsRequest _model = new();
    private bool _isLoading = true;
    private bool _isBusy;
    private string? _errorMessage;
    private string? _successMessage;
    private Dictionary<int, string> _initialBoostSelections = new();
    private readonly Dictionary<int, string> _boostSelections = new();
    private readonly Dictionary<int, List<BoostOptionDto>> _boostOptions = new();
    private bool _loadingBoostEligibility = true;
    private bool _hasVisibleBoosts;
    private List<PredictionLeagueDto> _leaguesWithBoosts = [];

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _pageData = await Http.GetFromJsonAsync<PredictionPageDto>($"api/predictions/{RoundId}");
            if (_pageData != null)
            {
                foreach (var match in _pageData.Matches)
                {
                    match.PredictedHomeScore ??= 0;
                    match.PredictedAwayScore ??= 0;
                }

                _model.RoundId = _pageData.RoundId;
                _model.Predictions = _pageData.Matches.Select(m => new PredictionSubmissionDto
                (
                    m.MatchId,
                    m.PredictedHomeScore ?? 0,
                    m.PredictedAwayScore ?? 0
                )).ToList();

                _initialBoostSelections = new Dictionary<int, string>();
                _leaguesWithBoosts = _pageData.Leagues.Where(l => l.HasBoosts).ToList();

                foreach (var leagueDto in _leaguesWithBoosts)
                {
                    var options = await BoostClient.GetAvailableBoostsAsync(leagueDto.LeagueId, _pageData.RoundId, CancellationToken.None);

                    var none = new BoostOptionDto
                    {
                        BoostCode = "None",
                        Name = "None",
                        Description = "No boost selected",
                        ImageUrl = "/images/boosts/none-normal.png",
                        SelectedImageUrl = "/images/boosts/none-selected.png",
                        DisabledImageUrl = "/images/boosts/none-disabled.png",
                        Eligibility = new BoostEligibilityDto { BoostCode = "None", LeagueId = leagueDto.LeagueId, RoundId = _pageData.RoundId, CanUse = true, RemainingSeasonUses = int.MaxValue, RemainingWindowUses = int.MaxValue, AlreadyUsedThisRound = false }
                    };

                    var list = new List<BoostOptionDto> { none };

                    if (options != null)
                        list.AddRange(options);

                    _boostOptions[leagueDto.LeagueId] = list;

                    _initialBoostSelections[leagueDto.LeagueId] = leagueDto.SelectedBoostCode ?? "None";
                    _boostSelections[leagueDto.LeagueId] = leagueDto.SelectedBoostCode ?? "None";
                }

                _hasVisibleBoosts = _boostOptions.Any(kvp =>
                {
                    var selected = _boostSelections.GetValueOrDefault(kvp.Key, "None");
                    return GetActionableOptions(kvp.Value, selected).Count > 0
                        || GetFutureBoostMessages(kvp.Value, selected).Count > 0;
                });
            }
        }
        finally
        {
            _isLoading = false;
            _loadingBoostEligibility = false;
        }
    }

    private string GetSelectedCode(int leagueId) => _boostSelections.GetValueOrDefault(leagueId, "None");
    private Task SetSelectedCode(int leagueId, string code) { _boostSelections[leagueId] = code; return Task.CompletedTask; }

    private static List<BoostOptionDto> GetActionableOptions(List<BoostOptionDto> allOptions, string selectedCode)
    {
        var actionable = allOptions.Where(o =>
            o.BoostCode == "None" ||
            o.BoostCode == selectedCode ||
            o.Eligibility?.CanUse == true ||
            o.Eligibility?.AlreadyUsedThisRound == true).ToList();

        return actionable.Count(o => o.BoostCode != "None") > 0 ? actionable : [];
    }

    private static List<string> GetFutureBoostMessages(List<BoostOptionDto> allOptions, string selectedCode)
    {
        return allOptions
            .Where(o =>
                o.BoostCode != "None" &&
                o.BoostCode != selectedCode &&
                o.Eligibility is { CanUse: false, AlreadyUsedThisRound: false, IsRoundInActiveWindow: false, NextWindowStartRound: not null, RemainingSeasonUses: > 0 })
            .Select(o => $"{o.Name} available from Round {o.Eligibility!.NextWindowStartRound}")
            .ToList();
    }

    private static void UpdateScore(MatchPredictionDto match, bool isHomeTeam, int delta)
    {
        if (isHomeTeam)
        {
            var currentScore = match.PredictedHomeScore ?? 0;
            var newScore = currentScore + delta;
            if (newScore >= 0 && newScore <= 9)
                match.PredictedHomeScore = newScore;
        }
        else
        {
            var currentScore = match.PredictedAwayScore ?? 0;
            var newScore = currentScore + delta;
            if (newScore >= 0 && newScore <= 9)
                match.PredictedAwayScore = newScore;
        }
    }

    private async Task HandleSubmitPredictionsAsync()
    {
        _isBusy = true;
        _errorMessage = null;
        _successMessage = null;

        if (_pageData != null)
        {
            _model.Predictions = _pageData.Matches.Select(m => new PredictionSubmissionDto
            (
                m.MatchId,
                m.PredictedHomeScore ?? 0,
                m.PredictedAwayScore ?? 0
            )).ToList();
        }

        try
        {
            foreach (var leagueDto in _leaguesWithBoosts)
            {
                var initial = _initialBoostSelections.ContainsKey(leagueDto.LeagueId) ? _initialBoostSelections[leagueDto.LeagueId] : "None";
                var current = _boostSelections.ContainsKey(leagueDto.LeagueId) ? _boostSelections[leagueDto.LeagueId] : "None";

                if (initial == current)
                    continue;

                if (initial != "None" && current == "None")
                {
                    var deleted = await BoostClient.DeleteUserBoostUsageAsync(leagueDto.LeagueId, _pageData!.RoundId, CancellationToken.None);
                    if (!deleted)
                    {
                        _errorMessage = $"Failed to remove boost for league {leagueDto.LeagueId}.";
                        _isBusy = false;
                        return;
                    }

                    _initialBoostSelections[leagueDto.LeagueId] = "None";
                    continue;
                }

                if (current == "None")
                    continue;

                if (initial != "None" && initial != current)
                {
                    var deleted = await BoostClient.DeleteUserBoostUsageAsync(leagueDto.LeagueId, _pageData!.RoundId, CancellationToken.None);
                    if (!deleted)
                    {
                        _errorMessage = $"Failed to remove previous boost for league {leagueDto.LeagueId}.";
                        _isBusy = false;
                        return;
                    }
                }

                var applyResult = await BoostClient.ApplyBoostAsync(leagueDto.LeagueId, _pageData!.RoundId, current, CancellationToken.None);
                if (applyResult == null || !applyResult.Success)
                {
                    _errorMessage = applyResult?.Error ?? $"Failed to apply {current} for league {leagueDto.LeagueId}.";
                    _isBusy = false;
                    return;
                }

                _initialBoostSelections[leagueDto.LeagueId] = current;
            }

            var response = await Http.PostAsJsonAsync("api/predictions/submit", _model);
            if (response.IsSuccessStatusCode)
            {
                _successMessage = "Your predictions have been saved successfully!";

                StateHasChanged();

                await Task.Delay(1500);

                NavigationManager.NavigateTo("/dashboard", forceLoad: true);
            }
            else
            {
                _errorMessage = "There was an error saving your predictions.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isBusy = false;
        }
    }
}