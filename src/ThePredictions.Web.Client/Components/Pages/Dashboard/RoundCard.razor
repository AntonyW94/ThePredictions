@using ThePredictions.Contracts.Dashboard
@using ThePredictions.Domain.Common.Enumerations

<div class="card slide">
    <div class="header">
        <h5 class="fw-bold text-white">@Round.SeasonName</h5>
        <small class="text-white-50 fw-bold">Round @Round.RoundNumber</small>
    </div>

    <div class="body">
        <dl class="mb-0 detail-list">
            <div class="detail-row centered">
                @if (IsInProgress)
                {
                    <div class="badge-group badge-group--blue pulsing-blue">
                        <span class="badge-icon" title="In Progress"><i class="bi bi-play-fill"></i></span>
                        <span>In Progress</span>
                    </div>
                }
                else if ((Round.DeadlineUtc - DateTime.UtcNow).TotalHours < 24)
                {
                    <CountdownTimer DeadlineUtc="Round.DeadlineUtc" />
                }
                else
                {
                    <div class="badge-group badge-group--red">
                        <span class="badge-icon" title="Deadline"><i class="bi bi-alarm"></i></span>
                        <LocalTime UtcDate="@Round.DeadlineUtc"/>
                    </div>
                }
            </div>
        </dl>

        @if (Round.Matches.Any())
        {
            <div class="match-preview-grid">
                @foreach (var match in Round.Matches)
                {
                    <div class="match-preview-row @GetMatchBackgroundClass(match) @GetMatchPulsingClass(match)">
                        <img src="@(match.HomeTeamLogoUrl ?? "images/team-placeholder.svg")"
                             class="match-preview-logo"
                             alt="Home"
                             loading="lazy"
                             onerror="this.onerror=null; this.src='images/team-placeholder.svg';" />
                        <span class="match-preview-score">@(match.PredictedHomeScore?.ToString() ?? "-")</span>
                        <span class="match-preview-vs">v</span>
                        <span class="match-preview-score">@(match.PredictedAwayScore?.ToString() ?? "-")</span>
                        <img src="@(match.AwayTeamLogoUrl ?? "images/team-placeholder.svg")"
                             class="match-preview-logo"
                             alt="Away"
                             loading="lazy"
                             onerror="this.onerror=null; this.src='images/team-placeholder.svg';" />
                    </div>
                }
            </div>
        }
    </div>
    <div class="footer">
        @if (IsDeadlinePassed && Round.OutcomeSummary != null)
        {
            <div class="outcome-summary">
                <span class="outcome-item">
                    <span>üéØ</span>
                    <span>@Round.OutcomeSummary.ExactScoreCount</span>
                </span>
                <span class="outcome-separator">¬∑</span>
                <span class="outcome-item">
                    <span>‚úÖ</span>
                    <span>@Round.OutcomeSummary.CorrectResultCount</span>
                </span>
                <span class="outcome-separator">¬∑</span>
                <span class="outcome-item">
                    <span>‚ùå</span>
                    <span>@Round.OutcomeSummary.IncorrectCount</span>
                </span>
            </div>
        }
        else if (!IsDeadlinePassed)
        {
            <NavLink href="@($"/predictions/{Round.Id}")" class="btn green-button w-100">
                @if (Round.HasUserPredicted)
                {
                    <span class="bi bi-pencil-fill me-2"></span>
                    <span>Edit Predictions</span>
                }
                else
                {
                    <span class="bi bi-pencil me-2"></span>
                    <span>Predict Now</span>
                }
            </NavLink>
        }
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public ActiveRoundDto Round { get; set; } = null!;

    private bool IsInProgress => Round.Status == RoundStatus.InProgress;
    private bool IsDeadlinePassed => Round.DeadlineUtc <= DateTime.UtcNow;

    private static string GetMatchBackgroundClass(ActiveRoundMatchDto match)
    {
        return match.Outcome switch
        {
            PredictionOutcome.ExactScore => "match-outcome-exact",
            PredictionOutcome.CorrectResult => "match-outcome-correct-result",
            PredictionOutcome.Incorrect => "match-outcome-incorrect",
            _ => "" // Pending or null - use default background
        };
    }

    private static string GetMatchPulsingClass(ActiveRoundMatchDto match)
    {
        if (match.Status != MatchStatus.InProgress)
            return "";

        return match.Outcome switch
        {
            PredictionOutcome.ExactScore => "pulsing-green",
            PredictionOutcome.CorrectResult => "pulsing-yellow",
            PredictionOutcome.Incorrect => "pulsing-red",
            _ => ""
        };
    }
}
