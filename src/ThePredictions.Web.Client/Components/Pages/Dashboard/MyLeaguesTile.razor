@inject NavigationManager NavigationManager
@inject IDashboardStateService DashboardState
@inject IBrowserService BrowserService

@using ThePredictions.Domain.Common.Enumerations
@using ThePredictions.Web.Client.Services.Browser
@using ThePredictions.Web.Client.Services.Dashboard

@implements IAsyncDisposable

<svg style="width:0;height:0;position:absolute;visibility:hidden;" aria-hidden="true" focusable="false">
    <defs>
        <linearGradient id="grad-gold" x1="20%" y1="0%" x2="80%" y2="100%">
            <stop offset="0%" stop-color="#C9B037" />
            <stop offset="40%" stop-color="#F2E29F" /> <stop offset="60%" stop-color="#AA8825" />
            <stop offset="100%" stop-color="#7A631A" />
        </linearGradient>

        <linearGradient id="grad-silver" x1="20%" y1="0%" x2="80%" y2="100%">
            <stop offset="0%" stop-color="#9CA3AF" />
            <stop offset="40%" stop-color="#F9FAFB" /> <stop offset="60%" stop-color="#6B7280" />
            <stop offset="100%" stop-color="#374151" />
        </linearGradient>

        <linearGradient id="grad-bronze" x1="20%" y1="0%" x2="80%" y2="100%">
            <stop offset="0%" stop-color="#8B5A2B" />
            <stop offset="40%" stop-color="#EBCBA6" /> <stop offset="60%" stop-color="#8B5A2B" />
            <stop offset="100%" stop-color="#5C3A1A" />
        </linearGradient>

        <linearGradient id="grad-blue" x1="20%" y1="0%" x2="80%" y2="100%">
            <stop offset="0%" stop-color="#3B82F6" />
            <stop offset="40%" stop-color="#93C5FD" /> <stop offset="60%" stop-color="#2563EB" />
            <stop offset="100%" stop-color="#1E40AF" />
        </linearGradient>

        <linearGradient id="grad-red" x1="20%" y1="0%" x2="80%" y2="100%">
            <stop offset="0%" stop-color="#EF4444" />
            <stop offset="40%" stop-color="#FCA5A5" /> <stop offset="60%" stop-color="#B91C1C" />
            <stop offset="100%" stop-color="#7F1D1D" />
        </linearGradient>

        <linearGradient id="rim-gold" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#FFF8D1" /> <stop offset="100%" stop-color="#C9B037" />
        </linearGradient>

        <linearGradient id="rim-silver" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#FFFFFF" />
            <stop offset="100%" stop-color="#9CA3AF" />
        </linearGradient>

        <linearGradient id="rim-bronze" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#FFE8CC" />
            <stop offset="100%" stop-color="#A67C52" />
        </linearGradient>

        <linearGradient id="rim-blue" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#E0F2FE" />
            <stop offset="100%" stop-color="#3B82F6" />
        </linearGradient>

        <linearGradient id="rim-red" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#FEE2E2" />
            <stop offset="100%" stop-color="#EF4444" />
        </linearGradient>

        <filter id="shield-shadow" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="0" dy="2" stdDeviation="1.5" flood-color="#000" flood-opacity="0.5" />
        </filter>
    </defs>
</svg>

<div class="section h-100">
    <h3 class="text-white text-center fw-bold mb-4">My Leagues</h3>

    <ApiError Message="@DashboardState.MyLeaguesErrorMessage" />

    @if (DashboardState.IsMyLeaguesLoading)
    {
        <div class="d-flex justify-content-center align-items-center flex-grow-1">
            <div class="spinner-border text-white" role="status">
                <span class="visually-hidden">Loading my leagues...</span>
            </div>
        </div>
    }
    else if (!DashboardState.MyLeagues.Any())
    {
        <p class="text-center text-white">You haven't joined any leagues yet.</p>
    }
    else
    {
        <div class="carousel-wrapper carousel--multi-item">
            <div class="carousel-container" @ontouchstart="HandleTouchStart" @ontouchmove="HandleTouchMove" @ontouchend="HandleTouchEnd">
                @if (_showTwoItems && DashboardState.MyLeagues.Count > 2)
                {
                    <button class="carousel-btn" @onclick="ShowPrevious" disabled="@(_currentIndex == 0)">
                        <span class="bi bi-chevron-left"></span>
                    </button>
                }

                <div class="carousel-track-wrapper">
                    <div class="carousel-track" style="@_trackStyle">
                        @foreach (var league in DashboardState.MyLeagues)
                        {
                            <div class="carousel-item-wrapper">
                                <div class="carousel-item-content">
                                    <div class="card slide">
                                        <div class="header">
                                            <h5 class="fw-bold text-white mb-0">@league.Name</h5>
                                            <small class="text-white-50 fw-bold">@league.SeasonName</small>
                                        </div>

                                        <div class="body pt-2 space-between">
                                            <div class="glass-panel hero-rank-container">
                                                <div class="text-center w-100">
                                                    <div class="text-uppercase text-white fw-bold mb-2 text-sm">Overall Rank</div>

                                                    <div class="d-flex align-items-center justify-content-center">
                                                        <RankChangeArrow
                                                            PreviousRank="@league.PreRoundOverallRank"
                                                            CurrentRank="@league.Rank.GetValueOrDefault()"
                                                            IsVisible="@(league.RoundStatus == nameof(RoundStatus.InProgress) && league.PreRoundOverallRank.HasValue && league.Rank.HasValue)" />

                                                        @if (league.Rank.HasValue && league.MemberCount.HasValue)
                                                        {
                                                            <div class="d-flex align-items-center gap-1">
                                                                <div class="rank-shield-container">
                                                                    @{ var overallColour = GetShieldColour(league.Rank, league.MemberCount); }
                                                                    <svg viewBox="0 0 24 24" class="rank-shield-icon" filter="url(#shield-shadow)">
                                                                        <path d="M12 2L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-3z" fill="url(#grad-@overallColour)" stroke="url(#rim-@overallColour)"/>
                                                                    </svg>
                                                                    <span class="rank-shield-text">
                                                                        @league.Rank
                                                                    </span>
                                                                </div>
                                                                <div class="text-white-50 fw-bold fs-6">/ @league.MemberCount</div>
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row g-2 mb-3">
                                                <div class="col-6">
                                                    <div class="glass-panel secondary-rank-box">
                                                        <small class="text-uppercase text-white fw-bold d-block mb-1 text-xs">@league.CurrentRound</small>
                                                        @if (league.RoundRank.HasValue)
                                                        {
                                                            <div class="d-flex align-items-center justify-content-center gap-1">
                                                                <RankChangeArrow
                                                                    PreviousRank="@league.StableRoundRank"
                                                                    CurrentRank="@league.RoundRank.GetValueOrDefault()"
                                                                    IsVisible="@(league.RoundStatus == nameof(RoundStatus.InProgress) && league.InProgressCount > 0 && league.CompletedCount > 0 && league.StableRoundRank.HasValue)" />

                                                                <div class="rank-shield-container small">
                                                                    @{ var roundColour = GetShieldColour(league.RoundRank, league.MemberCount); }
                                                                    <svg viewBox="0 0 24 24" class="rank-shield-icon" filter="url(#shield-shadow)">
                                                                        <path d="M12 2L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-3z" fill="url(#grad-@roundColour)" stroke="url(#rim-@roundColour)" />
                                                                    </svg>
                                                                    <span class="rank-shield-text">
                                                                        @league.RoundRank
                                                                    </span>
                                                                </div>
                                                                <div class="text-white-50 fw-bold fs-6">/ @league.MemberCount</div>
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-white-50">-</span>
                                                        }
                                                    </div>
                                                </div>

                                                <div class="col-6">
                                                    <div class="glass-panel secondary-rank-box">
                                                        <small class="text-uppercase text-white fw-bold d-block mb-1 text-xs">@league.CurrentMonth</small>
                                                        @if (league.MonthRank.HasValue)
                                                        {
                                                            <div class="d-flex align-items-center justify-content-center gap-1">
                                                                <RankChangeArrow
                                                                    PreviousRank="@league.PreRoundMonthRank"
                                                                    CurrentRank="@league.MonthRank.GetValueOrDefault()"
                                                                    IsVisible="@(league.RoundStatus == nameof(RoundStatus.InProgress) && league.PreRoundMonthRank.HasValue)" />

                                                                <div class="rank-shield-container small">
                                                                    @{ var monthColour = GetShieldColour(league.MonthRank, league.MemberCount); }
                                                                    <svg viewBox="0 0 24 24" class="rank-shield-icon" filter="url(#shield-shadow)">
                                                                        <path d="M12 2L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-3z" fill="url(#grad-@monthColour)" stroke="url(#rim-@monthColour)" />
                                                                    </svg>
                                                                    <span class="rank-shield-text">
                                                                        @league.MonthRank
                                                                    </span>
                                                                </div>
                                                                <div class="text-white-50 fw-bold fs-6">/ @league.MemberCount</div>
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-white-50">-</span>
                                                        }
                                                    </div>
                                                </div>
                                            </div>

                                            @if (league.TotalPrizeFund > 0)
                                            {
                                                <div class="row g-2 mb-3">
                                                    <div class="col-12">
                                                        <div class="glass-panel financial-row">
                                                            <div class="financial-col">
                                                                <small class="d-block text-uppercase fw-bold text-2xs">Won So Far</small>
                                                                <div class="fw-bold text-green-600 fs-5">
                                                                    @((MarkupString)$"&pound;{league.PrizeMoneyWon:0.00}")
                                                                </div>
                                                            </div>

                                                            <div class="financial-col">
                                                                <small class="d-block text-uppercase fw-bold text-2xs">Pot Remaining</small>
                                                                <div class="fw-bold text-white fs-5">
                                                                    @((MarkupString)$"&pound;{league.PrizeMoneyRemaining:0.00}")
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            }

                                            <button class="btn purple-accent-button w-100" @onclick="() => ViewLeagueDashboard(league.Id)">
                                                View Dashboard
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                @if (_showTwoItems && DashboardState.MyLeagues.Count > 2)
                {
                    <button class="carousel-btn" @onclick="ShowNext" disabled="@IsAtEnd()">
                        <span class="bi bi-chevron-right"></span>
                    </button>
                }
            </div>

            @if (NumberOfDots > 1)
            {
                <div class="carousel-dots">
                    @for (var i = 0; i < NumberOfDots; i++)
                    {
                        var dotIndex = i;
                        <span class="carousel-dot @(i == _currentIndex ? "active" : "")" @onclick="() => GoToSlide(dotIndex)"></span>
                    }
                </div>
            }
        </div>
    }
</div>

@code {
    private int _currentIndex;
    private double _touchStartX;
    private string _trackStyle = "transform: translateX(0%);";
    private bool _showTwoItems;

    protected override async Task OnInitializedAsync()
    {
        DashboardState.OnStateChange += StateHasChanged;
        _showTwoItems = await BrowserService.IsTabletOrAbove();

        if (!DashboardState.MyLeagues.Any())
            await DashboardState.LoadMyLeaguesAsync();
    }

    private int NumberOfDots
    {
        get
        {
            if (!DashboardState.MyLeagues.Any())
                return 0;

            var leaguesPerPage = _showTwoItems ? 2 : 1;

            if (DashboardState.MyLeagues.Count <= leaguesPerPage)
                return 0;

            return DashboardState.MyLeagues.Count - leaguesPerPage + 1;
        }
    }

    private void HandleTouchStart(TouchEventArgs e)
    {
        _touchStartX = e.Touches[0].ClientX;
    }

    private static void HandleTouchMove(TouchEventArgs e)
    {
    }

    private void HandleTouchEnd(TouchEventArgs e)
    {
        var touchEndX = e.ChangedTouches[0].ClientX;
        var diffX = _touchStartX - touchEndX;

        if (!(Math.Abs(diffX) > 50))
            return;

        if (diffX > 0)
            ShowNext();
        else
            ShowPrevious();
    }

    private void GoToSlide(int index)
    {
        if (index < 0 || index >= NumberOfDots)
            return;

        _currentIndex = index;
        UpdateTrackStyle();
    }

    private void ShowPrevious()
    {
        if (_currentIndex <= 0)
            return;

        _currentIndex--;
        UpdateTrackStyle();
    }

    private void ShowNext()
    {
        if (IsAtEnd())
            return;

        _currentIndex++;
        UpdateTrackStyle();
    }

    private void UpdateTrackStyle()
    {
        var percentageToMove = _showTwoItems ? 50 : 100;
        _trackStyle = $"transform: translateX(-{_currentIndex * percentageToMove}%);";
    }

    private bool IsAtEnd()
    {
        var leaguesPerPage = _showTwoItems ? 2 : 1;
        return _currentIndex >= DashboardState.MyLeagues.Count - leaguesPerPage;
    }

    private void ViewLeagueDashboard(int leagueId)
    {
        NavigationManager.NavigateTo($"/leagues/{leagueId}/dashboard");
    }

    private static string GetShieldColour(long? rank, int? memberCount)
    {
        switch (rank)
        {
            case null:
                return "blue";

            case 1:
                return "gold";

            case 2:
                return "silver";

            case 3:
                return "bronze";
        }

        if (memberCount > 4 && rank > memberCount.Value * 0.75)
            return "red";

        return "blue";
    }

    public ValueTask DisposeAsync()
    {
        DashboardState.OnStateChange -= StateHasChanged;
        return ValueTask.CompletedTask;
    }
}
