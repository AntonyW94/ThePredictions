@page "/leagues/{LeagueId:int}/prizes"

@attribute [Authorize]

@inject HttpClient Http
@inject NavigationManager NavigationManager

@using ThePredictions.Contracts.Leagues
@using ThePredictions.Domain.Common.Enumerations
@using ThePredictions.Web.Client.ViewModels.Leagues
@using System.Globalization

<PageTitle>Manage Prizes - @_pageData?.LeagueName</PageTitle>

<div class="page-container">
    <div class="form-container extra-wide">
        @if (_isLoading)
        {
            <p class="text-center text-white"><em>Loading prize information...</em></p>
        }
        else if (_pageData != null)
        {
            <h3 class="text-center fw-bold text-white mb-2">
                @(_pageData.PrizeSettings.Any() ? "Confirmed Winnings" : "Prize Structure")
            </h3>
            <h5 class="text-center form-sub-header mb-4">@_pageData.LeagueName</h5>

            <ApiError Message="@_errorMessage" />

            @if (DateTime.UtcNow < _pageData.EntryDeadlineUtc)
            {
                <div class="message-box-solid warning">
                    Prize setup is locked until the entry deadline has passed.
                </div>

                <div class="card">
                    <div class="body">
                        <div class="detail-list">
                            <div class="detail-row">
                            <div class="badge-group badge-group--red">
                                <span class="badge-icon"><i class="bi bi-alarm"></i></span>
                                <LocalTime UtcDate="@_pageData.EntryDeadlineUtc"/>
                            </div>

                            <div class="badge-group badge-group--green">
                                <span class="badge-icon"><i class="bi bi-currency-pound"></i></span>
                                <span>@((_pageData.Price * _pageData.MemberCount).ToString("C", new CultureInfo("en-GB")))</span>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="d-flex justify-content-start mt-4">
                    <button type="button" class="btn red-button d-flex align-items-center" @onclick="Back">
                        <span class="bi bi-arrow-left-circle-fill me-2"></span>Back
                    </button>
                </div>
            }
            else if (_pageData.PrizeSettings.Any())
            {
                <div class="card-grid">
                    <div class="card w-100">
                        <div class="header">
                            <h5 class="text-white text-center fw-bold mb-0">Overall Prizes</h5>
                        </div>
                        <div class="body">
                            @foreach (var prize in _pageData.PrizeSettings.Where(p => p.PrizeType == PrizeType.Overall).OrderBy(p => p.Rank))
                            {
                                <div class="prize-row">
                                    <div class="prize-icon"><span class="bi bi-trophy-fill"></span></div>
                                    <span class="prize-description">@prize.Rank<span>@FormattingUtilities.GetOrdinal(prize.Rank)</span><span class="d-none d-md-inline"> Place</span></span>
                                    <span class="prize-amount">@prize.PrizeAmount.ToString("C", new CultureInfo("en-GB"))</span>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="card w-100">
                        <div class="header">
                            <h5 class="text-white text-center fw-bold mb-0">Other Prizes</h5>
                        </div>
                        <div class="body">
                            @foreach (var prize in _pageData.PrizeSettings.Where(p => p.PrizeType == PrizeType.Round))
                            {
                                <div class="prize-row">
                                    <div class="prize-icon"><span class="bi bi-calendar3-event"></span></div>
                                    <span class="prize-description">Round<span class="d-none d-md-inline">&nbsp;Winner</span></span>
                                    <span class="prize-amount">@prize.PrizeAmount.ToString("C", new CultureInfo("en-GB"))</span>
                                </div>
                            }
                            @foreach (var prize in _pageData.PrizeSettings.Where(p => p.PrizeType == PrizeType.Monthly))
                            {
                                <div class="prize-row">
                                    <div class="prize-icon"><span class="bi bi-calendar-month"></span></div>
                                    <span class="prize-description">Monthly<span class="d-none d-md-inline">&nbsp;Winner</span></span>
                                    <span class="prize-amount">@prize.PrizeAmount.ToString("C", new CultureInfo("en-GB"))</span>
                                </div>
                            }
                            @foreach (var prize in _pageData.PrizeSettings.Where(p => p.PrizeType == PrizeType.MostExactScores))
                            {
                                <div class="prize-row">
                                    <div class="prize-icon"><span class="bi bi-bullseye"></span></div>
                                    <span class="prize-description">Exact Scores</span>
                                    <span class="prize-amount">@prize.PrizeAmount.ToString("C", new CultureInfo("en-GB"))</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-start mt-4">
                    <button type="button" class="btn red-button d-flex align-items-center" @onclick="Back">
                        <span class="bi bi-arrow-left-circle-fill me-2"></span>Back
                    </button>
                </div>
            }
            else if (_model != null)
            {
                <div class="card">
                    <div class="body no-padding">
                        <div class="text-center text-white mb-4">
                            <h5 class="text-white">Total Prize Pot to Allocate: @_model.PrizePot.ToString("C", new CultureInfo("en-GB"))</h5>
                        </div>

                        <BaseFormComponent TModel="DefinePrizesViewModel"
                                           Model="_model"
                                           SubmitAction="HandleDefinePrizesAsync"
                                           SuccessRedirectUrl="@($"/leagues/{LeagueId}/prizes")"
                                           BackUrl="/leagues"
                                           SuccessAlertMessage="Prize structure locked successfully!"
                                           BusyText="Saving...">
                            <ChildContent>
                                <div class="row">
                                    <div class="col-md-4 mb-4">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h5 class="text-white mb-0">Overall Prizes</h5>
                                            <button type="button" class="btn btn-sm purple-accent-button" @onclick="_model.AddOverallPrize">
                                                <span class="bi bi-plus-circle-fill me-1"></span>Add
                                            </button>
                                        </div>
                                        @foreach (var prize in _model.PrizeSettings.Where(p => p.PrizeType == PrizeType.Overall).OrderBy(p => p.Rank))
                                        {
                                            <div class="input-group mb-2">
                                                <span class="input-group-text prize-label"><span class="bi bi-trophy-fill"></span></span>
                                                <span class="input-group-text prize-label prize-label-fixed-width">@prize.PrizeDescription</span>
                                                <InputNumber class="form-control prize-amount-fixed-width" @bind-Value="prize.PrizeAmount" />
                                                <button type="button" class="btn red-button" @onclick="() => _model.RemoveOverallPrize(prize)" disabled="@(prize.Rank == 1)">
                                                    <span class="bi bi-trash-fill"></span>
                                                </button>
                                            </div>
                                        }
                                    </div>

                                    <div class="col-md-4 mb-4">
                                        <h5 class="text-white">Recurring Prizes</h5>
                                        <div class="input-group mb-2">
                                            <span class="input-group-text prize-label"><span class="bi bi-calendar-month"></span></span>
                                            <span class="input-group-text prize-label prize-label-fixed-width">Monthly<span class="d-none d-md-inline">&nbsp;Winner</span></span>
                                            <InputNumber class="form-control prize-amount-fixed-width" @bind-Value="_model.MonthlyWinnerAmount" />
                                            <span class="input-group-text prize-label prize-multiplier-fixed-width">x @_model.NumberOfMonths</span>
                                        </div>
                                        <div class="input-group mb-2">
                                            <span class="input-group-text prize-label"><span class="bi bi-calendar3-event"></span></span>
                                            <span class="input-group-text prize-label prize-label-fixed-width">Round<span class="d-none d-md-inline">&nbsp;Winner</span></span>
                                            <InputNumber class="form-control prize-amount-fixed-width" @bind-Value="_model.RoundWinnerAmount" />
                                            <span class="input-group-text prize-label prize-multiplier-fixed-width">x @_model.NumberOfRounds</span>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <h5 class="text-white">Special Prizes</h5>
                                        @foreach (var prize in _model.PrizeSettings.Where(p => p.PrizeType == PrizeType.MostExactScores))
                                        {
                                            <div class="input-group mb-2">
                                                <span class="input-group-text prize-label"><span class="bi bi-bullseye"></span></span>
                                                <span class="input-group-text prize-label prize-label-fixed-width">Exact Scores</span>
                                                <InputNumber class="form-control prize-amount-fixed-width" @bind-Value="prize.PrizeAmount" />
                                                <span class="input-group-text prize-label prize-multiplier-fixed-width">x 1</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                                <div class="prize-summary">
                                    <div class="badge-group @(_model.RemainingToAllocate == 0 ? "badge-group--green" : "badge-group--red")">
                                        <span class="badge-icon">
                                            <i class="bi bi-currency-pound"></i>
                                        </span>
                                        <span class="fs-5">
                                            Remaining: <strong>@_model.RemainingToAllocate.ToString("C", new CultureInfo("en-GB"))</strong>
                                        </span>
                                    </div>
                                </div>
                            </ChildContent>
                        </BaseFormComponent>
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    [Parameter] public int LeagueId { get; set; }

    private LeaguePrizesPageDto? _pageData;
    private DefinePrizesViewModel? _model;
    private bool _isLoading = true;
    private string? _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        _errorMessage = null;
        try
        {
            _pageData = await Http.GetFromJsonAsync<LeaguePrizesPageDto>($"api/leagues/{LeagueId}/prizes");

            if (_pageData != null && DateTime.UtcNow > _pageData.EntryDeadlineUtc && !_pageData.PrizeSettings.Any())
            {
                var prizePot = _pageData.Price * _pageData.MemberCount;
                _model = new DefinePrizesViewModel(prizePot, _pageData.NumberOfRounds, _pageData.SeasonStartDateUtc, _pageData.SeasonEndDateUtc);
            }
        }
        catch
        {
            _errorMessage = "Could not load prize information for this league.";
        }
        _isLoading = false;
    }

    private Task<HttpResponseMessage> HandleDefinePrizesAsync()
    {
        var request = new DefinePrizeStructureRequest
        {
            PrizeSettings = _model!.ToFinalPrizeSettings()
        };
        return Http.PostAsJsonAsync($"api/leagues/{LeagueId}/prizes", request);
    }

    private void Back() => NavigationManager.NavigateTo("/leagues");
}