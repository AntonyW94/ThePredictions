@page "/leagues/create"

@attribute [Authorize]

@inject HttpClient Http

@using ThePredictions.Contracts.Leagues

<PageTitle>Create League</PageTitle>

<div class="page-container">
    <div class="form-container">
        <h3 class="text-center fw-bold text-white mb-4">Create New League</h3>
        
        @if (_pageData == null)
        {
            <p class="text-center text-white"><em>Loading Create League...</em></p>
        }
        else
        {
            <BaseFormComponent TModel="CreateLeagueRequest"
                               Model="_model"
                               SubmitAction="HandleCreateLeagueAsync"
                               SuccessRedirectUrl="/leagues"
                               BackUrl="/leagues"
                               SuccessAlertMessage="League created successfully!"
                               BusyText="Creating League...">
                <ChildContent>
                    <div class="mb-3">
                        <label for="season" class="form-label text-white">Season</label>
                        <InputSelect id="season" class="form-select" @bind-Value="_model.SeasonId" @onchange="OnSeasonSelected">
                            @if (_pageData.Seasons.Count != 1)
                            {
                                <option value="0">-- Select a Season --</option>
                            }

                            @foreach (var season in _pageData.Seasons)
                            {
                                <option value="@season.Id">@season.Name</option>
                            }
                        </InputSelect>
                        <StyledValidationMessage For="@(() => _model.SeasonId)" />
                    </div>

                    <div class="mb-3">
                        <label for="name" class="form-label text-white">League Name</label>
                        <InputText id="name" class="form-control" @bind-Value="_model.Name" disabled="@ShouldDisableFields" />
                        <StyledValidationMessage For="@(() => _model.Name)" />
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="price" class="form-label text-white">Entry Fee (Â£)</label>
                            <InputNumber id="price" class="form-control" @bind-Value="_model.Price" placeholder="0.00" disabled="@ShouldDisableFields" />
                            <div class="form-text text-white-50">Enter 0 for a free-to-play league.</div>
                            <StyledValidationMessage For="@(() => _model.Price)" />
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="entryDeadline" class="form-label text-white">Entry Deadline</label>
                            <UtcInputDate id="entryDeadline"
                                          @bind-Value="_model.EntryDeadlineUtc"
                                          Class="form-control"
                                          Max="@MaxDate"
                                          Disabled="@ShouldDisableFields" />
                            <div class="form-text text-white-50">Deadline must be before the season starts.</div>
                            <StyledValidationMessage For="@(() => _model.EntryDeadlineUtc)" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="pointsForExactScore" class="form-label text-white">Points for Exact Score</label>
                            <InputNumber id="pointsForExactScore" class="form-control" @bind-Value="_model.PointsForExactScore" disabled="@ShouldDisableFields" />
                            <div class="form-text text-white-50">Points awarded for predicting the exact score.</div>
                            <StyledValidationMessage For="@(() => _model.PointsForExactScore)" />
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="pointsForCorrectResult" class="form-label text-white">Points for Correct Result</label>
                            <InputNumber id="pointsForCorrectResult" class="form-control" @bind-Value="_model.PointsForCorrectResult" disabled="@ShouldDisableFields" />
                            <div class="form-text text-white-50">Points awarded for predicting the winner/draw.</div>
                            <StyledValidationMessage For="@(() => _model.PointsForCorrectResult)" />
                        </div>
                    </div>
                </ChildContent>
            </BaseFormComponent>
        }
    </div>
</div>

@code {
    private CreateLeaguePageData? _pageData;
    private readonly CreateLeagueRequest _model = new();
    private bool ShouldDisableFields => _pageData?.Seasons.Count != 1 && _model.SeasonId == 0;
    private string? MaxDate { get; set; }
   

    protected override async Task OnInitializedAsync()
    {
        _pageData = await Http.GetFromJsonAsync<CreateLeaguePageData>("api/leagues/create-data");

        if (_pageData != null)
        {
            _model.PointsForExactScore = _pageData.DefaultPointsForExactScore;
            _model.PointsForCorrectResult = _pageData.DefaultPointsForCorrectResult;

            if (_pageData.Seasons.Count == 1)
            {
                var singleSeason = _pageData.Seasons.First();
                _model.SeasonId = singleSeason.Id;

                UpdateDeadlineAndMaxDate(singleSeason.StartDateUtc);
            }
        }
    }

    private void OnSeasonSelected(ChangeEventArgs e)
    {
        var selectedSeasonId = int.Parse(e.Value?.ToString() ?? "0");
        _model.SeasonId = selectedSeasonId;

        if (selectedSeasonId > 0 && _pageData != null)
        {
            var selectedSeason = _pageData.Seasons.FirstOrDefault(s => s.Id == selectedSeasonId);
            if (selectedSeason != null)
                UpdateDeadlineAndMaxDate(selectedSeason.StartDateUtc);
        }
        else
        {
            MaxDate = null;
        }
    }

    private void UpdateDeadlineAndMaxDate(DateTime seasonStartDateUtc)
    {
        var deadlineUtc = seasonStartDateUtc.AddDays(-1);
      
        _model.EntryDeadlineUtc = deadlineUtc;
        MaxDate = deadlineUtc.ToString("yyyy-MM-ddTHH:mm");
    }

    private Task<HttpResponseMessage> HandleCreateLeagueAsync()
    {
        return Http.PostAsJsonAsync("api/leagues/create", _model);
    }
}
