@page "/authentication/forgot-password"

@inject IAuthenticationService AuthenticationService
@inject NavigationManager NavigationManager

<PageTitle>Forgot Password</PageTitle>

<div class="page-container">
    <div class="form-container shadow">
        <div class="position-relative mb-4">
            <NavLink href="/authentication/login" class="back-button flex-center" title="Back to Login">
                <span class="bi bi-arrow-left-short"></span> Back to Login
            </NavLink>

            <div class="text-center mb-4 mt-2">
                <img src="/images/lion-outline-logo.jpg" alt="Lion Logo" class="max-w-60"/>
            </div>

            @if (_isSubmitted)
            {
                <h3 class="text-center fw-bold text-white">Check Your Email</h3>
                <p class="text-center text-white mb-4">
                    If an account exists with that email, you'll receive a password reset link shortly.
                </p>

                <div class="d-grid mt-4">
                    <NavLink href="/authentication/login" class="btn green-button text-purple-1000 input-height text-center d-flex align-items-center justify-content-center">
                        Back to Login
                    </NavLink>
                </div>
            }
            else
            {
                <h3 class="text-center fw-bold text-white">Forgot Password</h3>
                <h5 class="text-center fw-normal text-white mb-4">Enter your email to receive a reset link</h5>
            }
        </div>

        @if (!_isSubmitted)
        {
            <EditForm Model="_model" OnValidSubmit="HandleSubmitAsync" FormName="forgotPasswordForm">
                <DataAnnotationsValidator />
                <ApiError Message="@_errorMessage" />

                <div class="mb-3">
                    <InputText id="email"
                               class="form-control"
                               @bind-Value="_model.Email"
                               data-lpignore="true"
                               autocomplete="off"
                               placeholder="Email address"/>
                    <ValidationMessage For="@(() => _model.Email)" class="text-danger small mt-1" />
                </div>

                <div class="d-grid mt-4">
                    <button type="submit" class="btn green-button text-purple-1000 input-height" disabled="@_isBusy">
                        @if (_isBusy)
                        {
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            <span> Sending...</span>
                        }
                        else
                        {
                            <span>Send Reset Link</span>
                        }
                    </button>
                </div>
            </EditForm>
        }
    </div>
</div>

@code {
    private readonly ForgotPasswordModel _model = new();
    private string? _errorMessage;
    private bool _isBusy;
    private bool _isSubmitted;

    private async Task HandleSubmitAsync()
    {
        _isBusy = true;
        _errorMessage = null;

        var success = await AuthenticationService.RequestPasswordResetAsync(_model.Email);

        if (success)
        {
            _isSubmitted = true;
        }
        else
        {
            _errorMessage = "Something went wrong. Please try again.";
        }

        _isBusy = false;
    }

    private class ForgotPasswordModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Email is required")]
        [System.ComponentModel.DataAnnotations.EmailAddress(ErrorMessage = "Please enter a valid email address")]
        public string Email { get; set; } = string.Empty;
    }
}
